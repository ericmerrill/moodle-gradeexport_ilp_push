define(["jquery","gradeexport_ilp_push/page_info","core/ajax","core/notification","core/templates","core/str","core/log"],function(o,c,l,g,s,a,r){var f={failGrades:!1,incompleteGrades:!1,initAll:function(){o(".gradingtable .usergraderow").each(function(){f.initRow(o(this))})},initRow:function(d){d.find(".gradeselect").eq(0).change(function(){var e=o(this).val();c.gradeIsIncomplete(e)?d.find(".incomplete").show():d.find(".incomplete").hide(),c.gradeRequiresLastAttend(e)?d.find(".lastattend").show():d.find(".lastattend").hide(),f.updateVerification(d)}),d.find(".incompletedeadline input").eq(0).change(function(){f.updateVerification(d)}),d.find(".datelastattended input").eq(0).change(function(){f.updateVerification(d)}),d.find(".incompletegradeselect").eq(0).change(function(){f.updateVerification(d)}),d.find(".grademode .currentgrademode").eq(0).click(function(){f.showGradeModeSelector(d)}),d.find(".grademode .grademodeselect").eq(0).change(function(){f.changeGradeMode(d)}),d.find(".grademode .grademodeselect").eq(0).focusout(function(){f.hideGradeModeSelector(d)}),d.find(".togglehistory a").eq(0).click(function(e){e.preventDefault(),f.toggleHistory(d)}),f.updateVerification(d)},updateFormWarning:function(e,d,i,n){var t=e.find(d);t&&(t=t.eq(0),i?a.get_string(i,"gradeexport_ilp_push",n).done(function(e){s.renderPix("i/warning","core",e).then(function(e){t.html(e)}).fail(function(){r.debug("Failed to fetch the warning icon")})}):t.html(""))},updateVerification:function(e){if(!e.hasClass("locked")){var d=e.find(".gradeselect").eq(0).val(),i=e.find(".confirmcheckbox").eq(0),n=e.find(".grade .letter").eq(0).data("grade-key"),t=e.find(".grade .notequal").eq(0);n!=d?t.show():t.hide();var a=!1,r=!1,o="";if(d||(r=!0,o="invalid_grade"),f.updateFormWarning(e,".gradeerror",o),c.gradeIsIncomplete(d)){(o="")!=(a=e.find(".incompletedeadline input").eq(0)).val()&&c.isAllowedIncompleteDeadline(a.val())||(r=!0,o="invalid_incomplete_date"),""!=o&&(o=c.getIncompleteDeadlineStringName()),f.updateFormWarning(e,".incompletedateerror",o,c.getStringIncompleteDeadline());var l=e.find(".incompletegradeselect").eq(0);o="",l.val()?c.isAllowedIncompleteGrade(l.val())||(r=!0,o="invalid_incomplete_grade_wrong"):(r=!0,o="invalid_incomplete_grade_missing"),f.updateFormWarning(e,".incompletegradeerror",o,c.getIncompleteGrade())}c.gradeRequiresLastAttend(d)&&((o="")!=(a=e.find(".datelastattended input").eq(0)).val()&&c.isAllowedLastAttendDate(a.val())||(r=!0,o="invalid_datelastattended"),f.updateFormWarning(e,".datelastattendederror",o,c.getStringLastAttendDates())),r?i.prop("disabled",!0):i.prop("disabled",!1)}},showGradeModeSelector:function(e){var d=e.find(".grademode .currentgrademode"),i=e.find(".grademode .grademodeselect");d.hide(),i.show()},hideGradeModeSelector:function(e){var d=e.find(".grademode .currentgrademode"),i=e.find(".grademode .grademodeselect");d.show(),i.hide()},changeGradeMode:function(i){var d=i.find(".grademode .currentgrademode"),n=i.find(".grademode .grademodeselect"),e=n.find("select").eq(0).val(),t=i.data("user-id"),a=i.data("row-id"),r=i.closest("form").find('input[name="courseid"]').val();l.call([{methodname:"gradeexport_ilp_push_update_row_grade_mode",args:{rowid:a,grademodeid:e,studentid:t,courseid:r},done:function(e){if(0<e.warnings.length)return g.alert(e.warnings[0].message,e.warnings[0].item),d.show(),void n.hide();s.render("gradeexport_ilp_push/user_row",JSON.parse(e.rowdata)).then(function(e,d){return i.siblings('tr[data-row-id="'+a+'"]').remove(),s.replaceNode(i,e,d),i=o('.gradingtable .usergraderow[data-row-id="'+a+'"]').eq(0),f.initRow(i),null}).fail(function(e){g.exception(e)})},fail:g.exception}])},toggleHistory:function(e){var d=o("#historyrow-"+e.data("row-id")+" td.historycell"),i=d.find(".historydiv");d.is(":hidden")?(d.slideDown(100),i.slideDown(400)):(i.animate({height:0},400,function(){i.hide(),i.height("auto")}),d.hide(400))}};return f});