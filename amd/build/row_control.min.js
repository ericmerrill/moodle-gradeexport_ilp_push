define(["jquery","gradeexport_ilp_push/page_info","core/ajax","core/notification","core/templates","core/str","core/log"],function(a,b,c,d,e,f,g){var h={failGrades:!1,incompleteGrades:!1,initAll:function(){a(".gradingtable .usergraderow").each(function(){h.initRow(a(this))})},initRow:function(c){var d=c.find(".gradeselect").eq(0);d.change(function(){var d=a(this).val();b.gradeIsIncomplete(d)?(c.find(".incomplete").show(),c.find(".fail").hide()):b.gradeIsFailure(d)?(c.find(".incomplete").hide(),c.find(".fail").show()):(c.find(".incomplete").hide(),c.find(".fail").hide()),h.updateVerification(c)}),c.find(".incompletedeadline input").eq(0).change(function(){h.updateVerification(c)}),c.find(".datelastattended input").eq(0).change(function(){h.updateVerification(c)}),c.find(".incompletegradeselect").eq(0).change(function(){h.updateVerification(c)}),c.find(".grademode .currentgrademode").eq(0).click(function(){h.showGradeModeSelector(c)}),c.find(".grademode .grademodeselect").eq(0).change(function(){h.changeGradeMode(c)}),h.updateVerification(c)},updateFormWarning:function(a,b,c,d){var h=a.find(b);if(h)return h=h.eq(0),c?void f.get_string(c,"gradeexport_ilp_push",d).done(function(a){e.renderPix("i/warning","core",a).then(function(a){h.html(a)}).fail(function(){g.debug("Failed to fetch the warning icon")})}):void h.html("")},updateVerification:function(a){if(!a.hasClass("locked")){var c=a.find(".gradeselect").eq(0),d=c.val(),e=a.find(".confirmcheckbox").eq(0),f=a.find(".grade .letter").eq(0).data("grade-key"),g=a.find(".grade .notequal").eq(0);f!=d?g.show():g.hide();var i=!1,j=!1,k="";if(d||(j=!0,k="invalid_grade"),h.updateFormWarning(a,".gradeerror",k),b.gradeIsIncomplete(d)){i=a.find(".incompletedeadline input").eq(0),k="",""==i.val()?(j=!0,k="invalid_incomplete_date"):b.isAllowedIncompleteDeadline(i.val())||(j=!0,k="invalid_incomplete_date"),h.updateFormWarning(a,".incompletedateerror",k,b.getStringIncompleteDeadline());var l=a.find(".incompletegradeselect").eq(0);k="",l.val()?b.isAllowedIncompleteGrade(l.val())||(j=!0,k="invalid_incomplete_grade_wrong"):(j=!0,k="invalid_incomplete_grade_missing"),h.updateFormWarning(a,".incompletegradeerror",k,b.getIncompleteGrade())}else b.gradeIsFailure(d)&&(i=a.find(".datelastattended input").eq(0),k="",""==i.val()?(j=!0,k="invalid_datelastattended"):b.isAllowedLastAttendDate(i.val())||(j=!0,k="invalid_datelastattended"),h.updateFormWarning(a,".datelastattendederror",k,b.getStringLastAttendDates()));j?e.prop("disabled",!0):e.prop("disabled",!1)}},showGradeModeSelector:function(a){var b=a.find(".grademode .currentgrademode"),c=a.find(".grademode .grademodeselect");b.hide(),c.show()},changeGradeMode:function(b){var f=b.find(".grademode .currentgrademode"),g=b.find(".grademode .grademodeselect"),i=g.find("select").eq(0).val(),j=b.data("user-id"),k=b.data("row-id"),l=b.closest("form").find('input[name="courseid"]').val();c.call([{methodname:"gradeexport_ilp_push_update_row_grade_mode",args:{rowid:k,grademodeid:i,studentid:j,courseid:l},done:function(c){return c.warnings.length>0?(d.alert(c.warnings[0].message,c.warnings[0].item),f.show(),void g.hide()):void e.render("gradeexport_ilp_push/user_row",JSON.parse(c.rowdata)).then(function(c,d){return b.siblings('tr[data-row-id="'+k+'"]').remove(),e.replaceNode(b,c,d),b=a('.gradingtable .usergraderow[data-row-id="'+k+'"]').eq(0),h.initRow(b),null}).fail(function(a){d.exception(a)})},fail:d.exception}])}};return h});