define(["jquery","gradeexport_ilp_push/page_info","core/templates","core/str","core/log"],function(n,c,d,r,l){var f={failGrades:!1,incompleteGrades:!1,initAll:function(){n(".gradingtable .usergraderow").each(function(){f.initRow(n(this))})},initRow:function(i){i.find(".gradeselect").eq(0).change(function(){var e=n(this).val();c.gradeIsIncomplete(e)?(i.find(".incomplete").show(),i.find(".fail").hide()):c.gradeIsFailure(e)?(i.find(".incomplete").hide(),i.find(".fail").show()):(i.find(".incomplete").hide(),i.find(".fail").hide()),f.updateVerification(i)}),i.find(".incompletedeadline input").eq(0).change(function(){f.updateVerification(i)}),i.find(".datelastattended input").eq(0).change(function(){f.updateVerification(i)}),i.find(".incompletegradeselect").eq(0).change(function(){f.updateVerification(i)}),f.updateVerification(i)},updateFormWarning:function(e,i,n,a){var t=e.find(i);t&&(t=t.eq(0),n?r.get_string(n,"gradeexport_ilp_push",a).done(function(e){d.renderPix("i/warning","core",e).then(function(e){t.html(e)}).fail(function(){l.debug("Failed to fetch the warning icon")})}):t.html(""))},updateVerification:function(e){if(!e.hasClass("locked")){var i=e.find(".gradeselect").eq(0).val(),n=e.find(".confirmcheckbox").eq(0),a=e.find(".grade .letter").eq(0).data("grade-key"),t=e.find(".grade .notequal").eq(0);a!=i?t.show():t.hide();var d=!1,r=!1,l="";if(i||(r=!0,l="invalid_grade"),f.updateFormWarning(e,".gradeerror",l),c.gradeIsIncomplete(i)){(l="")!=(d=e.find(".incompletedeadline input").eq(0)).val()&&c.isAllowedIncompleteDeadline(d.val())||(r=!0,l="invalid_incomplete_date"),f.updateFormWarning(e,".incompletedateerror",l,c.getStringIncompleteDeadline());var o=e.find(".incompletegradeselect").eq(0);l="",o.val()?c.isAllowedIncompleteGrade(o.val())||(r=!0,l="invalid_incomplete_grade_wrong"):(r=!0,l="invalid_incomplete_grade_missing"),f.updateFormWarning(e,".incompletegradeerror",l,c.getIncompleteGrade())}else c.gradeIsFailure(i)&&((l="")!=(d=e.find(".datelastattended input").eq(0)).val()&&c.isAllowedLastAttendDate(d.val())||(r=!0,l="invalid_datelastattended"),f.updateFormWarning(e,".datelastattendederror",l,c.getStringLastAttendDates()));r?n.prop("disabled",!0):n.prop("disabled",!1)}}};return f});